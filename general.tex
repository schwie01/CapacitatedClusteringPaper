\section{General Case}
\chris{There is no exposition that ties the lemmas together. I have no idea how anyone is supposed to understand this. Also, since most of the proofs are in the appendix, it is very hard to follow, because it is poorly referenced.}

In this section, we show how to construct coresets for capacitated clustering beyond the ring case. Let $c$ be a center point, $P$ be a (positively) weighted data set,  $W:=\sum_{p\in P} w(p)$ denote the total weight of $P$, and $\mu:=\cost(P,c)/W$ denote the average cost. By Section \ref{sec:basic}, we can construct additive coresets for close points by decomposing them into multiple rings with exponentially increasing radius.\chris{I think we should define $C_{close}$ and $C_{far}$ somewhere and not just in the proof of lemma 1.4 or the statement of lemma 2.1. I have difficulty keeping the definitions straight otherwise.}

\begin{lemma} \label{lemma:closepoints}
Let $P_{close}:=\{p\in P| \cost(p,c)\leq \frac{k}{\epsilon^2}\cdot \mu\}$. Then one can construct a weighted subset $D$ of $P_{close} $ such that for any solution $S, w(S)=W$, we have
$$
|\cost(D,S)-\cost(P,S)|\leq \epsilon \cost(P,S)+\epsilon\cost(P,c).
$$
\end{lemma}

We remain to deal with far points in $P$. Let $P_{far}:=P\setminus P_{close}$. We employ the following sensitivty sampling to construct coresets for $P_{far}$.

\paragraph{SensitivitySampling} works as the following. 

\begin{itemize}
\item Take a sample $G$ of size $m=O(\frac{k}{\epsilon^3}\log \delta^{-1})$ from $P_{far}$ where every $p\in P_{far}$ is sampled with probability $\frac{\cost(p,c)}{\cost(P_{far},c)}$ and will be assigned weight $w_G(p):=\frac{\cost(P_{far},c)}{m\cdot \cost(p,c)}$. Here, $\delta$ is the failure probability that will be fixed later.
\item Let $D$ denote the coreset constructed by Lemma \ref{lemma:closepoints}. Let $D_{new}:=D\cap G$.
\item Scaling the weight of $D_{new}$ so as $w(D_{new})=W$. Return $D_{new}$ as an $\epsilon$-coreset for $P$.
\end{itemize}

\begin{lemma} \label{lemma:singlecluster}
$D_{new}$ is an $\epsilon$-coreset of $P$ for capacitated clustering.
\end{lemma}

We first prove our sample has coreset property for a single solution in Lemma \ref{lemma:singlesolution}. Then we can use a discretization technique and union bound to prove Lemma \ref{lemma:singlecluster}.

We call a $k$-set $S$ a \emph{regular $k$-set} if $|S|=k$ for each $s\in S$, $w(S)=W$ and $w(s)\geq \frac{\epsilon}{k}\cdot W$.
\begin{lemma} \label{lemma:singlesolution}
Let $S$ be a regular $k$-set. Then with probability $1-\delta$, 
$$
|\cost(P,S)-\cost(D_{new},S)|\leq \epsilon (\cost(P,c)+\cost(P,S)).
$$
\end{lemma}

In the following, we fix a regular $k$-set $S$. Consider an optimal assignment from $P$ to $S$ and for each $p\in P$, we use $S(p)$ to denote the center that serves $p$. For $s\in S$, naturally $S^{-1}(s)=\{p\in P|S(p)=s\}$. Let $P^{S,close}_{far}:=\{p\in P_{far}| \cost(p,S(p))\leq \epsilon^{-1}\cost(p,c)\}$ denote the set of points in $P_{far}$ that contribute at most $\epsilon^{-1}$ times their cost in the cluster centered at $c$. We prove the following lemmas.

\begin{lemma} \label{lemma:assignment}
Let $X$ denote a weighted subset of $P$ and for any $s\in S$, $w(S^{-1}(s))=w(X\cap S^{-1}(s))$, then
$\cost(X,S)=\sum_{x\in X} d(x,S(x))$. Namely, if $X$ has the same weight in all the clusters of $P$ generated by $S$, then an optimal assignment from $X$ to $P$ should connect each point to the same center as the assignment from $P$ to $S$.

\end{lemma}

\begin{proof}
For sake of contradiction, we assume $\cost(X,S)<\sum_{x\in X} d(x,S(x))$. Let $\delta>0$ be a small enough constant such that for each $x\in P$, $\delta \cdot w_X(x)\leq w_P(x)$. 

So $P$ contains a weighted subset $\delta\cdot X$. We observe that in the assignment from $P$ to $S$, each $x\in P$ is assigned to $S(p)$ by definition. However, as $\cost(X,S)<\sum_{x\in X} d(x,S(x))$ and $X$ has the same weight as $P$ in each cluster, there actually exists a better assignment of this subset $\delta X$ by using the same capacity of each center. By updating the assignment of $\delta X$, we obtain a new assignment from $P$ to $S$ with a smaller cost, which is contradict to the fact that $\cost(P,S)$ uses the optimal assignment.
\end{proof}


\begin{lemma} \label{lemma:close}
Let $G^{S,close}:=G\cap P_{far}^{S,close}$. Then with probability $1-\delta$,
\begin{eqnarray*}
&&\bigg{|}\sum_{p\in P_{far}^{S,close}}w(p)\cost(p,S(p))\\&-&\sum_{p\in G^{S,close}}w_G(p)\cost(p,S(p))\bigg{|}\\
&\leq& \epsilon\cdot \cost(P,c)+\epsilon\cdot \cost(P,S)
\end{eqnarray*}
\end{lemma}





\begin{lemma} \label{lemma:controlfar}
Let $H$ be a weighted subset of $P$. Suppose $w(H)\leq \frac{\epsilon^2}{k}\cdot W$, and for any $h\in H$, $d(h,S(h))
\leq d(h,c)/\epsilon$, then $$\sum_{h\in H} w(h)\cdot d(h,S(h))\leq O(\epsilon) \cdot (\cost(P,c)+\cost(P,S))$$.
\end{lemma}


The next lemma controls the total weight of $D_{new}$ before scaling.

\begin{lemma} \label{lemma:weight}
With probability at least $1-\delta$,
$$
|w_G(G)-w(P_{far})|\leq \epsilon\cdot W.
$$
\end{lemma}

\chris{the following claim is wrong, and not salvageable. I attempted to read the proof in the appendix. I am not sure what is supposedly proven, but it is bogus, lacking any semblance of rigor. any future proof attempt should avoid the ideas contained in the proof of the appendix}
\begin{lemma} \label{lemma:far}
Ã¸Let $P_{far}^{S,far}:=P_{far}\setminus P_{far}^{S,close}$ and $G^{S,far}:=G\cap P_{far}^{S,far}$, then 
\begin{itemize}
    \item $\sum_{p\in P_{far}^{S,far}} w(p)d(p,S(p)) \leq O(\epsilon)\cdot (\cost(P,S)+\cost(P,c))$
    \item  $\sum_{x\in G_{far}^{S,far}} w_G(x)d(x,S(x)) \leq O(\epsilon)\cdot (\cost(P,S)+\cost(P,c))$
\end{itemize}


\end{lemma}



So far, we can prove the following lemma that connecting each coreset point the same center as in the optimal assignment from $P$ to $S$ can yield a close assignment. 

\begin{lemma} \label{lemma:rawcoreset}
Let $D_{new}$ denote the coreset produced by \textsf{SensitivitySampling}. Then with probability $1-\delta$,
\begin{eqnarray*}
&&\bigg{|}
\sum_{x\in D} w_D(x)d(x,S(X))-\cost(P,S)
\bigg{|}\\
&\leq& O(\epsilon)\cdot (\cost(P,S)+\cost(P,c)).
\end{eqnarray*}
\end{lemma}

\begin{proof}
A combination of Lemma \ref{lemma:weight}, Lemma \ref{lemma:far}, Lemma \ref{lemma:close}.
\end{proof}

\chris{avoid "proofs" like these. given the lack of rigor everywhere else, I wouldn't trust it}

A remaining issue is that we need to control $\cost(D_{new},S)$ instead of $\sum_{x\in D_{new}} w_D(x)d(x,S)$. We need to show that the latter is close to the optimal assignment $\cost(D_{new},S)$.  We further make a slight modification on the surplus to apply Lemma \ref{lemma:assignment}.

\begin{lemma} \label{lemma:substitute}
There is a weighted subset $Q\subseteq P$ such that 

\begin{itemize}
    \item for each $s\in S$, $w_Q(S^{-1}(s)\cap Q)=w(S^{-1}(s))$, 
    \item $
|\cost(D_{new},S)-\cost(Q,S)|\leq O(\epsilon \cdot \cost(P,c)+\epsilon\cdot \cost(P,S)),
$
and 
\item connection cost on $D_{new}$ is close to that on $Q$, i.e,
\begin{eqnarray*}
&&\bigg{|}\sum_{x\in D_{new}} w_D(x) d(x,S(x))\\&-&\sum_{x\in Q} w_Q(x) d(x,S(x))
\bigg{|}\\&\leq& O(\epsilon \cdot \cost(P,c)+\epsilon\cdot \cost(P,S)).
\end{eqnarray*}
\end{itemize}
\end{lemma}

\begin{proof}
Recall that $D_{new}=D\cap G$, we oberseve that we can repalce $D$ with $P_{close}$ by paying at most $\epsilon (\cost(P,S)+\cost(P,c))$ by Lemma \ref{lemma:closepoints}.

It remains to deal with surplus. By Lemma \ref{lemma:weight}, we scale the weight only by a factor of $1\pm O(\epsilon)$. So each cluster's weight differs by an $O(\epsilon)$ fraction. Hence we are able to deal with the surplus, by paying at most $\epsilon\cdot  \cost(P,c)$, via transporting through the center $c$.
\end{proof}

We are ready to prove Lemma \ref{lemma:singlesolution}
\begin{proof}[Proof of Lemma \ref{lemma:singlesolution}]
A combination of Lemma \ref{lemma:substitute}, Lemma \ref{lemma:assignment}, and Lemma \ref{lemma:rawcoreset}.
\end{proof}

